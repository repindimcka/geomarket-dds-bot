# Telegram-бот для реестра ДДС

Бот добавляет операции в Google Таблицу «ДДС: месяц»: поступления, выбытия и переводы между счетами. Справочники (кошельки, статьи, направление бизнеса) читаются из таблицы.

## Что нужно

- Python 3.10+
- Токен Telegram-бота ([@BotFather](https://t.me/BotFather))
- Google Таблица с листами: **ДДС: месяц**, **ДДС: настройки (для ввода сальдо)**, **Справочники**, **ДДС: статьи**
- Сервисный аккаунт Google с доступом к этой таблице

## Установка

```bash
cd dds-telegram-bot
python3 -m venv .venv
source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

На macOS, если команды `python` и `pip` не найдены, используйте `python3` и после активации окружения — `pip` (или `pip3`).

## Настройка

1. **Токен бота**  
   Создайте бота в @BotFather и скопируйте токен.

2. **ID таблицы**  
   В URL таблицы:  
   `https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit`  
   скопируйте `SPREADSHEET_ID`.

3. **Сервисный аккаунт Google**
   - [Google Cloud Console](https://console.cloud.google.com/) → проект → «APIs & Services» → «Credentials» → «Create Credentials» → «Service account».
   - Создайте ключ (JSON) и сохраните файл как `credentials.json` в папке бота.
   - Таблицу откройте для редактирования по email сервисного аккаунта (из JSON: `client_email`). Достаточно прав «Редактор».
   - **Если бот пишет «Invalid control character» или «Expecting ':' delimiter» при загрузке балансов** — в `credentials.json` попали лишние переносы строк или другие управляющие символы. Лучше всего: в Google Cloud Console откройте сервисный аккаунт → «Keys» → создайте новый ключ (JSON), скачайте его и замените им старый `credentials.json`. Либо откройте `credentials.json` в редакторе и проверьте поле `private_key`: оно должно быть **одной строкой** в кавычках, с символами `\n` внутри (а не с настоящими переносами строк).

4. **Файл .env**  
   Скопируйте `.env.example` в `.env` и заполните:

```env
TELEGRAM_BOT_TOKEN=123456:ABC...
GOOGLE_SHEET_ID=ваш_id_таблицы
GOOGLE_CREDENTIALS_PATH=credentials.json
# Необязательно: ограничить бота только своими аккаунтами (ID через запятую). Узнать свой ID: @userinfobot
# TELEGRAM_ALLOWED_IDS=123456789,987654321
```

**Ограничение доступа:** если в `.env` задана переменная `TELEGRAM_ALLOWED_IDS` (через запятую перечислите Telegram user ID), бот будет отвечать только этим пользователям. Остальные при любом действии получат сообщение «Доступ к боту ограничен.» Узнать свой ID можно, например, у бота [@userinfobot](https://t.me/userinfobot). Если переменную не задавать, бот доступен всем, кто найдёт его по ссылке.

## Запуск

```bash
source .venv/bin/activate   # если ещё не активировано
python bot.py               # или python3 bot.py
```

### Режимы работы

**1. Ввод текстом (по умолчанию)** — одно сообщение в коротком формате.

**Тип операции:**
- **минус** или **выбытие** — выбытие  
- **плюс**, **поступление** или **доход** — поступление  
- **перевод** — перевод  

**Примеры:**
- Перевод: `Перевод 5000 Сбербанк Касса` — сегодня 5000 ₽ с Сбербанка на Кассу (сумма, откуда, куда).
- Поступление: `Плюс 5000 Сбербанк Поступления от оказания услуг` — сумма, кошелёк, статья.
- Выбытие: `Минус 5000 Касса Фонд оплаты труда` — сумма, кошелёк, статья.

Дата по умолчанию — сегодня. После двух кошельков в переводе можно дописать назначение: `Перевод 5000 Сбербанк Касса пополнение`.

**2. Пошаговый режим** — команда **/step**: дата → тип → статья → кошелёк → сумма → контрагент (можно пропустить) → назначение (можно пропустить). В любой момент: **/cancel** или кнопка «Отмена».

**Команды (соответствуют меню в BotFather):**
- **/start** (Запуск) — пошаговый ввод в ДДС: дата (сегодня или ввод) → тип операции → статья → кошелёк → сумма → контрагент/назначение (можно пропустить)
- **/balance** (Баланс) — показать баланс счетов (актуальные данные из листа «ДДС: месяц»)
- **/text** (Текстовый ввод) — подсказка формата; затем одно сообщение вида «Перевод 5000 Сбербанк Касса» — бот разберёт и введёт операцию
- **/cancel** (Отмена) — сбросить/отменить текущий ввод
- **/step** — то же, что /start (пошаговый ввод)

Справочники (кошельки, статьи, направления) кэшируются на 5 минут — отклик быстрее.

## Логика заполнения

- **Поступление / Выбытие:** статьи берутся из листа «ДДС: статьи» по группе Поступление/Выбытие, **исключая** статьи с «Вид деятельности» = «Техническая операция» (они используются только для переводов). Для выбытия сумма в таблицу записывается с минусом.
- **Перевод:** В таблицу добавляются две строки: выбытие с первого кошелька и поступление на второй; контрагент не заполняется. Статьи перевода (с «Техническая операция») подставляются автоматически.
- Направление бизнеса (колонка F) подставляется автоматически: если в «Справочники» одно значение — без вопроса.
- Колонки A, B, J, K бот не заполняет (считаются формулами в таблице).

## Структура листов в таблице

| Лист | Назначение для бота |
|------|----------------------|
| ДДС: месяц | Реестр операций. Бот добавляет строки и заполняет только C–I. |
| ДДС: настройки (для ввода сальдо) | Список кошельков — колонка A с 3-й строки. |
| Справочники | Направление бизнеса — колонка A со 2-й строки. |
| ДДС: статьи | Статьи: колонка A — название, колонка B — «Поступление» или «Выбытие». Для переводов бот ищет в таблице статьи, в названии которых есть слова «перевод» и «счетами» (по одной в группе Выбытие и Поступление) и подставляет их точные значения — так не будет ошибки проверки данных. |

Если названия листов или колонок у вас отличаются, их можно поменять в `sheet_service.py` (константы в начале файла).

## Ошибка «Invalid control character» при /balance

Балансы читаются из листа **«ДДС: месяц»** из диапазона **A1:E3**. Проверьте эти ячейки:

| Строка | Ячейки | Что проверить |
|--------|--------|----------------|
| 1 | A1, B1, C1, D1, E1 | Нет ли переноса строки (Enter/Alt+Enter), таба, лишних пробелов в начале/конце |
| 2 | A2, B2, C2, D2, E2 | То же |
| 3 | A3, B3, C3, D3, E3 | То же (A3 — обычно итог, B/C и D/E — кошелёк и сумма) |

**Что сделать:** откройте каждую ячейку (двойной клик), удалите переносы строк и лишние символы, оставьте только текст или число. Сохраните и снова выполните /balance.
