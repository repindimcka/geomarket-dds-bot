# Структура и логика таблицы ДДС в Google Sheets

Документ описывает, как устроена таблица ДДС (движение денежных средств), с которой работает Telegram-бот. Можно передать в другую ветку/чат для настройки копии таблицы или интеграции.

---

## 1. Общая идея

- Одна Google Таблица (один файл) с **несколькими листами**.
- Бот **читает** справочники и балансы, **записывает** только новые строки в реестр операций.
- Колонки **A, B, J, K** в реестре — **по формулам в таблице**, бот их не заполняет. Бот заполняет только **C–I**.

---

## 2. Листы таблицы (имена строго такие)

| Имя листа | Назначение |
|-----------|------------|
| **ДДС: месяц** | Реестр операций. Сверху — блок балансов (строки 1–3), ниже — список операций. Бот добавляет строки и заполняет колонки C–I. |
| **ДДС: настройки (для ввода сальдо)** | Список кошельков и слоты для добавления новых. Колонка A с 3-й строки: слоты 1–12. |
| **Справочники** | Направление бизнеса. Колонка A со 2-й строки — одно или несколько значений. |
| **ДДС: статьи** | Справочник статей ДДС. Колонка A — название, B — группа («Поступление» / «Выбытие»), C — вид деятельности (в т.ч. «Техническая операция» для переводов). |
| **ДДС: Сводный** | Сводка по месяцам для отчёта /stats. Строки 3–14 — кошельки (колонка A — имя). Колонки B..M — месяцы 1..12. |

Имена листов заданы в коде (`sheet_service.py`). Если переименовать лист в таблице, нужно поправить константы в коде.

---

## 3. Лист «ДДС: месяц» (реестр операций)

### 3.1. Верхний блок (строки 1–3): балансы

- **Диапазон:** по сути **A1:I3** (бот читает его для балансов).
- **A** — служебное; в **A3** часто формула/итог «Итого».
- **12 слотов «кошелёк / баланс»** — пары колонок и строки:
  - Пары колонок: **B/C**, **D/E**, **F/G**, **H/I** (4 пары).
  - Строки: 1, 2, 3 (3 строки).
  - Порядок слотов (сверху вниз по парам):  
    B1,C1 → B2,C2 → B3,C3 → D1,E1 → … → H3,I3.
- В каждой паре: первая колонка — **название кошелька**, вторая — **баланс** (число или формула).
- Свободный слот для нового кошелька: ячейка названия пустая или содержит только цифру 1–12.

**Важно:** в ячейках A1:E3 (и вообще в этом блоке) не должно быть переносов строк (Enter), табов и лишних пробелов — иначе возможны ошибки при чтении балансов.

### 3.2. Реестр операций (ниже 3-й строки)

- Бот **добавляет строки** и заполняет **только колонки C–I** (одна строка = одна операция).
- **A, B** — служебные/формулы, бот не трогает.
- **J, K** — по формулам в таблице, бот не трогает.

**Колонки C–I (как в коде и в таблице):**

| Колонка | Буква | Содержимое |
|---------|--------|------------|
| C | COL_DATE | Дата операции (формат ДД.ММ.ГГГГ) |
| D | COL_AMOUNT | Сумма: положительная — поступление, отрицательная — выбытие |
| E | COL_WALLET | Кошелёк (название из справочника) |
| F | COL_DIRECTION | Направление бизнеса |
| G | COL_COUNTERPARTY | Контрагент |
| H | COL_PURPOSE | Назначение платежа |
| I | COL_ARTICLE | Статья (название из листа «ДДС: статьи») |

- Следующая строка для записи определяется так: первая строка, где в колонке C (дата) уже нет данных.
- Запись идёт диапазоном вида `C{N}:I{N}` одной строкой массивом:  
  `[дата, сумма, кошелёк, направление, контрагент, назначение, статья]`.

**Перевод между счетами:** бот добавляет **две** строки — выбытие с одного кошелька (сумма с минусом) и поступление на другой (сумма плюс). Статьи для перевода берутся из «ДДС: статьи» (названия содержат «перевод» и «счетами»), контрагент в этих строках пустой.

---

## 4. Лист «ДДС: настройки (для ввода сальдо)»

- **Колонка A, с 3-й строки:** слоты для кошельков 1–12 (строки 3–14).
- Значение в A:
  - **Только цифра 1–12** — слот свободен (здесь можно добавить новый кошелёк).
  - **Текст (название кошелька)** — слот занят, это имя существующего кошелька.
- Бот читает список кошельков: все непустые значения из колонки A с 3-й строки, **кроме** чисто цифровых (1–12).

При **добавлении кошелька** через бота:
- Ищется первый свободный слот (A = цифра 1–12).
- В таблице есть **скрытые листы** с именами `"1"` … `"12"` — по номеру слота находится лист, показывается и переименовывается в имя кошелька.
- В листе кошелька в **A1** записывается имя (для выпадающих списков/формул).
- В листе **«ДДС: Сводный»** показывается строка, соответствующая слоту, и в колонку A записывается имя кошелька.
- В листе **«ДДС: месяц»** первый свободный слот в верхнем блоке (B/C…H/I) заполняется именем кошелька (и, при необходимости, балансом по логике таблицы).

---

## 5. Лист «Справочники»

- **Колонка A, со 2-й строки:** направления бизнеса (одно или несколько значений).
- Если значение одно — бот подставляет его автоматически; если несколько — запрашивает выбор у пользователя.

---

## 6. Лист «ДДС: статьи»

- **Колонка A** — название статьи (как показывается в боте и как записывается в реестр).
- **Колонка B** — группа: **«Поступление»** или **«Выбытие»** (без кавычек в ячейке).
- **Колонка C** — вид деятельности; значение **«Техническая операция»** — статьи только для переводов между счетами, в выборе статей для поступлений/выбытий бот их не показывает.

Для **переводов** бот ищет статьи, в названии которых есть слова **«перевод»** и **«счетами»**: по одной в группе «Выбытие» и по одной в группе «Поступление». Их точные названия из таблицы подставляются в колонку I при записи перевода.

---

## 7. Лист «ДДС: Сводный»

- Используется для отчёта **/stats** (сводка по месяцу) и при добавлении кошелька.
- **Колонка A** — подписи строк (например: «Денег на начало месяца», «Изменение денег за месяц», «Денег на конец месяца», «Выручка»/«Доходы», «Расходы»). Бот ищет по частичному совпадению с этими фразами (в нижнем регистре).
- **Колонки B..M** — месяцы 1–12. Значения — числа (балансы, доходы, расходы).
- **Строки 3–14** — соответствуют кошелькам 1–12; в колонке A после добавления кошелька записывается его имя.

Для отчёта по **диапазону дат** бот считает по реестру «ДДС: месяц» (сумма положительных = доходы, сумма отрицательных по модулю = расходы, изменение = доходы − расходы), а текущий итоговый баланс берёт из верхнего блока «ДДС: месяц» (A1:I3).

---

## 8. Переменные окружения (для бота)

- **GOOGLE_SHEET_ID** — ID таблицы (из URL: `https://docs.google.com/spreadsheets/d/ЭТОТ_ID/edit`).
- **GOOGLE_CREDENTIALS_PATH** — путь к JSON ключу сервисного аккаунта (например `credentials.json`).
- Сервисный аккаунт должен иметь доступ к таблице (например, «Редактор»). Email ключа — в поле `client_email` в JSON.

---

## 9. Файл правил отчислений (в репозитории бота)

- **fund_rules.json** — правила «Рассчитать фонды» в боте.
- Формат: массив объектов с полями **source**, **destination**, **percent** (источник, целевой фонд, процент от суммы).
- Пример: `[{"source":"Сбербанк","destination":"Фонд Развития","percent":10}, ...]`
- Логика отчислений реализована в боте; таблица хранит только операции (поступления/выбытия/переводы), которые бот добавляет в «ДДС: месяц».

---

## 10. Краткая схема «где что»

- **Балансы сейчас** → «ДДС: месяц», диапазон A1:I3, пары (название, баланс) в B/C, D/E, F/G, H/I по строкам 1–3.
- **Список кошельков** → «ДДС: настройки (для ввода сальдо)», колонка A с 3-й строки (без ячеек только с цифрой 1–12).
- **Направления бизнеса** → «Справочники», колонка A со 2-й строки.
- **Статьи** → «ДДС: статьи», колонки A (название), B (Поступление/Выбытие), C (вид деятельности).
- **Новые операции** → «ДДС: месяц», одна или две строки в конец реестра, колонки C–I.
- **Сводка по месяцу** → «ДДС: Сводный», колонка A — подписи, B..M — месяцы; или расчёт по реестру за диапазон дат + текущий итог из «ДДС: месяц».

Этого достаточно, чтобы воспроизвести структуру таблицы или описать её в другой ветке/чате.
